<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</title>
  <style>
    :root{
      --bg:#fafafa; --fg:#0f172a; --muted:#6b7280; --card:#ffffff; --bd:#e5e7eb;
      --pink:#fbcfe8; --sky:#bae6fd; --white:#ffffff; --orange:#ffedd5;
      --picked:#f5e9da; --picked-fg:#3b2b1f; --green:#bbf7d0; --red:#fecaca;
      /* –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è —Ä—è–¥–∫—ñ–≤ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∏ */
      --row-ok:#e8f7e8;      /* –±–ª—ñ–¥–æ–∑–µ–ª–µ–Ω–∏–π */
      --row-warn:#fff6cc;    /* –±–ª—ñ–¥–æ-–∂–æ–≤—Ç–∏–π */
      --row-bad:#ffe1ea;     /* –±–ª—ñ–¥–æ-—Ä–æ–∂–µ–≤–∏–π */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    /* layout */
    .container{max-width:840px;margin:0 auto;padding:8px}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.95);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--bd)}
    h1{font-size:18px;margin:0}
    .row{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid #0284c7;background:#0284c7;color:#fff;border-radius:12px;padding:8px 12px;font-weight:600}
    .btn[disabled]{border-color:#d1d5db;background:#e5e7eb;color:#6b7280}
    .select{width:100%;border:1px solid var(--bd);border-radius:12px;padding:10px;font-size:14px;background:#fff}

    /* list */
    ul.list{list-style:none;padding:0;margin:12px 0 48px;display:grid;gap:10px}
    .card{border-radius:16px;box-shadow:0 1px 2px #0001, 0 6px 16px #0001;overflow:hidden;cursor:pointer}
    .card > .p{padding:12px}
    .top{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
    .titleLine{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .dot{width:6px;height:6px;border-radius:999px;background:#0f172a;opacity:.5}
    .number{font-weight:800}
    .client{font-weight:700}
    .date{font-size:12px;opacity:.8;text-align:right}
    .badges{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 10px;font-size:12px;font-weight:700;border:1px solid #0001;background:#fff;white-space:nowrap}
    .i{font-size:14px;line-height:1}
    .grid2{margin-top:10px;display:grid;gap:8px}
    @media(min-width:560px){.grid2{grid-template-columns:1fr 1fr}}
    .muted{color:var(--muted)}
    .error{color:#dc2626;font-size:12px;margin-top:4px}

    /* —Å—Ç–∞–Ω–∏ */
    .st-new{background:var(--pink)}
    .st-manager{background:var(--sky)}
    .st-to-warehouse{background:var(--white)}
    .st-picking{background:var(--orange)}
    .st-picked{background:var(--picked); color:var(--picked-fg)}
    .st-shipped{background:var(--green)}
    .st-await{background:var(--red)}

    /* —Ç–∞–±–ª–∏—Ü—è —Ç–æ–≤–∞—Ä—ñ–≤ */
    .goodsWrap{padding:0 12px 12px}
    .goodsPanel{
      overflow:hidden;
      height:0;
      transition:height .28s ease;
      will-change:height;
    }
    .goodsTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background:#fff;
      border:1px solid var(--bd);
      border-radius:12px;
      overflow:hidden;
    }
    .goodsTable th, .goodsTable td{
      padding:8px 10px;
      font-size:13px;
      border-bottom:1px solid var(--bd);
    }
    .goodsTable th{
      text-align:left;
      background:#f8fafc;
      position:sticky; top:0; /* —Ç—Ä—ñ—à–∫–∏ –∑—Ä—É—á–Ω—ñ—à–µ –Ω–∞ –º–æ–±—ñ */
      z-index:1;
    }
    .goodsTable tr:last-child td{border-bottom:none}
    .col-name{width:100%}
    .col-num{width:0;white-space:nowrap;text-align:right}

    /* –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ —Ä—è–¥–∫—ñ–≤ */
    .row-ok    { background:var(--row-ok) }
    .row-warn  { background:var(--row-warn) }
    .row-bad   { background:var(--row-bad) }

    .copyBtn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      margin-left: 6px;
    }
.copyBtn:hover { opacity: 0.7; }

.toast {
      position: fixed;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      background: #333; color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      opacity: 0; transition: opacity .3s;
      z-index: 1000;
    }
.toast.show { opacity: 1; }

    /* –¥—Ä—ñ–±–Ω–∏—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ */
    .card:focus-visible{outline:2px solid #0284c7; outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <div class="container" style="padding:8px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1 id="title">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>
        <button id="refreshBtn" class="btn">–û–Ω–æ–≤–∏—Ç–∏</button>
      </div>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <select id="statusSelect" class="select" style="min-width:180px"></select>
      </div>
      <div id="error" class="error" role="alert" hidden></div>
    </div>
  </header>

  <main class="container">
    <ul id="list" class="list"></ul>
    <div id="empty" class="muted" style="text-align:center;margin-top:24px" hidden>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>
    <footer class="muted" style="text-align:center;margin:24px 0 56px">–î–∂–µ—Ä–µ–ª–æ: –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ VETAi. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ —á–∞—Å—Ç—ñ—à–µ 1/—Ö–≤. –ö–µ—à: localStorage.</footer>
  </main>

<script>
(() => {
  const WEBHOOK_URL = 'https://n8n.vetai.win/webhook/4c9d9576-0942-437c-8212-52512b0b7c0e';
  
// === IVM context from Telegram + query ===
const tg = window.Telegram?.WebApp;
tg?.ready?.(); tg?.expand?.();

const urlCtx = new URL(location.href);
const q = Object.fromEntries(urlCtx.searchParams.entries()); // –æ—á—ñ–∫—É—î–º–æ ?uid=&role=&jwt= –∑ index.html

const TG_INIT_DATA = tg?.initData || "";               // —Å–∏—Ä–∏–π —Ä—è–¥–æ–∫ –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ
const TG_USER      = tg?.initDataUnsafe?.user || null; // {id, username, language_code, photo_url, ...}
const uidFromTG    = TG_USER?.id ? String(TG_USER.id) : "";

  
  const LS_KEY_DATA = 'orders_cache_v3';
  const LS_KEY_TS   = 'orders_cache_ts_v3';
  const COOLDOWN_MS = 60_000;

  const els = {
    title: document.getElementById('title'),
    list: document.getElementById('list'),
    empty: document.getElementById('empty'),
    error: document.getElementById('error'),
    refreshBtn: document.getElementById('refreshBtn'),
    statusSelect: document.getElementById('statusSelect'),
  };

  /* helpers */
  function formatUAH(n){
    const num = typeof n === 'string' ? Number(n.replace(',', '.')) : Number(n);
    if (!isFinite(num)) return '';
    return new Intl.NumberFormat('uk-UA',{style:'currency',currency:'UAH',maximumFractionDigits:2}).format(num);
  }
  function formatDateTime(iso){
    if (!iso) return '‚Äî';
    const d = new Date(iso);
    if (isNaN(+d)) return iso;
    return d.toLocaleString('uk-UA',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
  }
  function formatDate(iso){
    const d = new Date(iso); if (isNaN(+d)) return iso || '‚Äî';
    return d.toLocaleDateString('uk-UA',{day:'2-digit',month:'2-digit',year:'numeric'});
  }
  function statusClass(s){
    s = (s||'').trim();
    if (s === '–ù–æ–≤–∏–π') return 'st-new';
    if (s === '–û–±—Ä–æ–±–ª—è—î—Ç—å—Å—è (–º–µ–Ω.)') return 'st-manager';
    if (s === '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥') return 'st-to-warehouse';
    if (s === '–ó–±–∏—Ä–∞—î—Ç—å—Å—è (—Å–∫–ª.)') return 'st-picking';
    if (s === '–ó—ñ–±—Ä–∞–Ω–æ (—Å–∫–ª.)') return 'st-picked';
    if (s === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ (—Å–∫–ª.)') return 'st-shipped';
    if (s === '–û—á—ñ–∫—É—î–º–æ –æ–ø–ª–∞—Ç—É') return 'st-await';
    return '';
  }
  function statusIcon(s){
    s = (s||'').trim();
    if (s === '–ù–æ–≤–∏–π') return 'üÜï';
    if (s === '–û–±—Ä–æ–±–ª—è—î—Ç—å—Å—è (–º–µ–Ω.)') return 'üë§';
    if (s === '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥') return 'üì¶';
    if (s === '–ó–±–∏—Ä–∞—î—Ç—å—Å—è (—Å–∫–ª.)') return 'üõ†Ô∏è';
    if (s === '–ó—ñ–±—Ä–∞–Ω–æ (—Å–∫–ª.)') return '‚úÖ';
    if (s === '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ (—Å–∫–ª.)') return 'üöö';
    if (s === '–û—á—ñ–∫—É—î–º–æ –æ–ø–ª–∞—Ç—É') return 'üí∞';
    return '‚ÑπÔ∏è';
  }

  let data = [];
  let openRef = null; // —è–∫–∞ –∫–∞—Ä—Ç–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞

  function setTitleFromData(){
    if (!data.length) { els.title.textContent = '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è'; return; }
    const m = (data[0].IM_MANAGER || '').trim();
    const from = data[0].IM_DATE_FROM ? formatDate(data[0].IM_DATE_FROM) : '‚Äî';
    const to   = data[0].IM_DATE_TO   ? formatDate(data[0].IM_DATE_TO)   : '‚Äî';
    els.title.textContent = `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ${m || '‚Äî'} (${from} - ${to})`;
  }

  function buildStatusList(){
    const set = new Set(data.map(o => (o.IM_STATUS||'').trim()).filter(Boolean));
    const opts = ['–í—Å—ñ —Å—Ç–∞–Ω–∏', ...Array.from(set.values())];
    els.statusSelect.innerHTML = opts.map(s => `<option value="${s}">${s}</option>`).join('');
  }

  /* –ª–æ–≥—ñ–∫–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏ —Ä—è–¥–∫–∞ —Ç–æ–≤–∞—Ä—É */
  function rowClassForItem(orderStatus, qty, res, picked){
    const doneStatuses = new Set(['–ó—ñ–±—Ä–∞–Ω–æ (—Å–∫–ª.)','–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ (—Å–∫–ª.)']);
    if (doneStatuses.has((orderStatus||'').trim())){
      if (Number(picked) >= Number(qty)) return 'row-ok';
      if (Number(picked) > 0) return 'row-warn';
      return 'row-bad';
    } else {
      if (Number(res) >= Number(qty)) return 'row-ok';
      if (Number(res) > 0) return 'row-warn';
      return 'row-bad';
    }
  }

  function goodsTableHTML(order){
    const goods = Array.isArray(order.IM_GOODS) ? order.IM_GOODS : [];
    if (goods.length === 0) return '<div class="muted" style="padding:8px 0">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –≤—ñ–¥—Å—É—Ç–Ω—è</div>';

    const rows = goods.map(g => {
      const cls = rowClassForItem(order.IM_STATUS, g.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, g.–†–µ–∑–µ—Ä–≤, g.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–°–æ–±—Ä–∞–Ω–æ);
      return `
        <tr class="${cls}">
          <td class="col-name">${g.IM_NOMENKLATURA || '‚Äî'}</td>
          <td class="col-num">${g.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ?? '‚Äî'}</td>
          <td class="col-num">${g.–†–µ–∑–µ—Ä–≤ ?? '‚Äî'}</td>
          <td class="col-num">${g.–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ–°–æ–±—Ä–∞–Ω–æ ?? '‚Äî'}</td>
        </tr>`;
    }).join('');

    return `
      <div class="goodsWrap">
        <div class="goodsPanel" role="region" aria-label="–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞">
          <table class="goodsTable">
            <thead>
              <tr>
                <th class="col-name">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</th>
                <th class="col-num">–ó–∞–º.</th>
                <th class="col-num">–†–µ–∑.</th>
                <th class="col-num">–ó—ñ–±.</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      </div>`;
  }

  /* –∞–Ω—ñ–º–∞—Ü—ñ—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è */
  function openPanel(panel){
    if (!panel) return;
    panel.style.display = 'block';
    const target = panel.scrollHeight;
    panel.style.height = '0px';
    requestAnimationFrame(()=> {
      panel.style.height = target + 'px';
    });
  }
  function closePanel(panel){
    if (!panel) return;
    const current = panel.scrollHeight;
    panel.style.height = current + 'px';
    requestAnimationFrame(()=> {
      panel.style.height = '0px';
    });
  }
  function afterTransition(e){
    if (e.propertyName !== 'height') return;
    const panel = e.currentTarget;
    if (panel.style.height === '0px'){
      panel.style.display = 'none';
    } else {
      panel.style.height = 'auto';
    }
  }

  function render(){
    const statusFilter = els.statusSelect.value;
    const sorted = [...data].sort((a,b)=> new Date(b.IM_DATE) - new Date(a.IM_DATE));
    let filtered = sorted;
    if (statusFilter && statusFilter !== '–í—Å—ñ —Å—Ç–∞–Ω–∏'){
      filtered = filtered.filter(o => (o.IM_STATUS||'').trim() === statusFilter);
    }

    els.list.innerHTML = '';
    if (filtered.length === 0){
      els.empty.hidden = false;
      return;
    }
    els.empty.hidden = true;

    const frag = document.createDocumentFragment();
    filtered.forEach(o => {
      const li = document.createElement('li');
      li.className = `card ${statusClass(o.IM_STATUS)}`;
      li.tabIndex = 0;
      li.dataset.ref = o.IM_NUMBER || Math.random().toString(36).slice(2);

      li.innerHTML = `
        <div class="p">
          <div class="top">
            <div class="titleLine">
              <div class="number">${o.IM_NUMBER || '‚Äî'}</div>
              <div class="dot" aria-hidden="true"></div>
              <div class="client">${o.IM_CLIENT || '‚Äî'}</div>
            </div>
            <div class="date">${formatDateTime(o.IM_DATE)}</div>
            ${o.IM_ORGANISATION ? `<div style="margin-top:8px"><strong>–ü—Ä–æ–¥–∞–≤–µ—Ü—å:</strong> ${o.IM_ORGANISATION}</div>` : ''}
            ${o.IM_ORG_PAYINFO ? `<button class="copyBtn" data-rekv="${encodeURIComponent(o.IM_ORG_PAYINFO)}">üí∞</button>` : ''}
          </div>

          <div class="badges">
            ${o.IM_STATUS ? `<span class="badge"><span class="i">${statusIcon(o.IM_STATUS)}</span>${o.IM_STATUS}</span>` : ''}
            ${o.IM_DOSTAVKA ? `<span class="badge"><span class="i">üöö</span>${o.IM_DOSTAVKA}</span>` : ''}
            ${(o.IM_SUM ?? '') !== '' ? `<span class="badge"><span class="i">‚Ç¥</span>${formatUAH(o.IM_SUM)}</span>` : ''}
          </div>

          ${(o.IM_DRIEVER || o.IM_DRIEVER_PHONE) ? `
            <div class="grid2">
              <div><strong>–ö—É—Ä'—î—Ä:</strong> ${o.IM_DRIEVER || '‚Äî'}</div>
              <div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${o.IM_DRIEVER_PHONE ? `<a class="tel" href="tel:${o.IM_DRIEVER_PHONE}">${o.IM_DRIEVER_PHONE}</a>` : '‚Äî'}</div>
            </div>
          ` : ''}

          ${o.IM_COMENT ? `<div style="margin-top:8px"><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong> ${o.IM_COMENT}</div>` : ''}
        </div>

        ${goodsTableHTML(o)}
      `;

      // –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –∞–∫–æ—Ä–¥–µ–æ–Ω—É
      const panel = li.querySelector('.goodsPanel');
      panel.addEventListener('transitionend', afterTransition);
      panel.style.display = 'none'; // —Å—Ç–∞—Ä—Ç: –∑–≥–æ—Ä–Ω—É—Ç–æ

      li.addEventListener('click', (ev) => {
        // –Ω–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞—Ç–∏ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ tel:
        const a = ev.target.closest('a');
        if (a && a.classList.contains('tel')) return;

        const ref = li.dataset.ref;

        // —è–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–∞ —ñ–Ω—à–∞ ‚Äî –∑–∞–∫—Ä–∏–≤–∞—î–º–æ
        if (openRef && openRef !== ref){
          const openLi = els.list.querySelector(`li.card[data-ref="${openRef}"]`);
          if (openLi){
            const openPanel = openLi.querySelector('.goodsPanel');
            closePanel(openPanel);
          }
          openRef = null;
        }

        const isOpen = panel.style.display !== 'none' && panel.style.height !== '0px';
        if (isOpen){
          closePanel(panel);
          openRef = null;
        } else {
          openPanel(panel);
          openRef = ref;
        }
      });

      // –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å: —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Enter/Space
      li.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); li.click(); }
      });

      frag.appendChild(li);
    });
    els.list.appendChild(frag);
  }

  function showToast(msg){
  let t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=> {
    t.classList.remove('show');
    setTimeout(()=> t.remove(), 300);
  }, 1500);
}

document.addEventListener('click', e=>{
  const btn = e.target.closest('.copyBtn');
  if (!btn) return;
  const text = decodeURIComponent(btn.dataset.rekv || '');
  if (!text) return;
  navigator.clipboard.writeText(text).then(()=>{
    showToast('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä');
  });
});

  function useCache(){
    try{
      const raw = localStorage.getItem(LS_KEY_DATA);
      if (!raw) return false;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)){
        data = arr;
        setTitleFromData();
        buildStatusList();
        render();
        return true;
      }
    }catch{}
    return false;
  }

  function setError(msg){
    if (!msg){ els.error.hidden = true; els.error.textContent = ''; return; }
    els.error.hidden = false; els.error.textContent = msg;
  }

  function updateRefreshButton(){
    const last = Number(localStorage.getItem(LS_KEY_TS) || 0);
    const left = Math.max(0, COOLDOWN_MS - (Date.now() - last));
    if (left === 0){
      els.refreshBtn.disabled = false;
      els.refreshBtn.textContent = '–û–Ω–æ–≤–∏—Ç–∏';
    } else {
      els.refreshBtn.disabled = true;
      els.refreshBtn.textContent = `–ß–µ—Ä–µ–∑ ${Math.ceil(left/1000)}s`;
    }
  }

let inFlight = false;

async function fetchData(force){
  if (inFlight) return;           // –Ω–µ –¥–∞—î–º–æ —Å—Ç–∞—Ä—Ç—É–≤–∞—Ç–∏ –¥—Ä—É–≥–æ–º—É –∑–∞–ø–∏—Ç—É
  inFlight = true;

  setError('');
  const last = Number(localStorage.getItem(LS_KEY_TS) || 0);
  const due = Date.now() - last >= COOLDOWN_MS;
  if (!force && !due){
    useCache();
    updateRefreshButton();
    inFlight = false;             // ‚Üê –Ω–µ –∑–∞–±—É–¥—å –ø–æ–≤–µ—Ä–Ω—É—Ç–∏
    return;
  }
  els.refreshBtn.disabled = true; els.refreshBtn.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è‚Ä¶';

  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 15000);
  try{
    // –ë—É–¥—É—î–º–æ URL –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
const u = new URL(WEBHOOK_URL);
u.searchParams.set('uid',  q.uid  || uidFromTG || '');
u.searchParams.set('role', q.role || '');           // –Ω–∞–ø—Ä. manager/admin/...
u.searchParams.set('lang', TG_USER?.language_code || 'uk');
if (q.jwt) u.searchParams.set('jwt', q.jwt);        // –∑ —ñ–Ω–¥–µ–∫—Å–Ω–æ–≥–æ —à–ª—é–∑—É

// –ó–∞ –ø–æ—Ç—Ä–µ–±–∏: —Ñ—ñ–ª—å—Ç—Ä–∏ (–∑–∞–ª–∏—à, —è–∫—â–æ –≤–∂–µ —Ä–æ–±–∏—à —ó—Ö –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ)
// u.searchParams.set('status', els.statusSelect.value || '');

// –í –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî —Å–∏—Ä–∏–π initData (–∫—Ä–∞—â–µ —è–∫ base64, —â–æ–± —É–Ω–∏–∫–∞—Ç–∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ñ–≤)
function b64(s){ try{ return btoa(unescape(encodeURIComponent(s))); }catch(_){ return ''; } }
const headers = {
  'Accept': 'application/json',
  'X-IVM-InitData-B64': b64(TG_INIT_DATA),    // –±–µ–∫–µ–Ω–¥ –∑–º–æ–∂–µ —Ä–æ–∑–∫–æ–¥—É–≤–∞—Ç–∏ —ñ –ø—Ä–æ–≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å
  'X-IVM-Platform': tg?.platform || 'unknown',
  'X-IVM-Version':  tg?.version  || 'n/a',
};

const res = await fetch(u.toString(), {
  method:'GET',
  headers,
  signal: ctrl.signal
});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error('–û—á—ñ–∫—É—î—Ç—å—Å—è –º–∞—Å–∏–≤ –æ–±\'—î–∫—Ç—ñ–≤');

    data = json.map(o => ({
      ...o,
      IM_STATUS: (o.IM_STATUS||'').trim(),
      IM_SUM: typeof o.IM_SUM === 'string' ? Number(o.IM_SUM.replace(',', '.')) : o.IM_SUM,
    }));

    localStorage.setItem(LS_KEY_DATA, JSON.stringify(data));
    localStorage.setItem(LS_KEY_TS, String(Date.now()));
    openRef = null;
    setTitleFromData();
    buildStatusList();
    render();
  } catch(e){
    setError(e?.message || '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
    useCache();
  } finally {
    clearTimeout(t);
    updateRefreshButton();
    inFlight = false;            // ‚Üê —Ä–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
  }
}

  // init
  useCache();
  fetchData(false);

  els.refreshBtn.addEventListener('click', ()=> fetchData(true));
  els.statusSelect.addEventListener('change', ()=>{
    openRef = null; // —Ñ—ñ–ª—å—Ç—Ä –∑–º—ñ–Ω–∏–≤—Å—è ‚Äî –∑–≥–æ—Ä—Ç–∞—î–º–æ
    render();
  });
  
  setInterval(updateRefreshButton, 1000);

  // –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–µ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è (—Ä–∞–∑ –Ω–∞ 5 —Ö–≤–∏–ª–∏–Ω)
  // --- –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–Ω–≥–æ–º –ª–∏—à–µ —É –≤–∏–¥–∏–º—ñ–π –≤–∫–ª–∞–¥—Ü—ñ ---
let pollTimer = null;
const POLL_MS = 300_000; // 5 —Ö–≤

function startPolling(){
  if (pollTimer) return; // –≤–∂–µ –∑–∞–ø—É—â–µ–Ω–æ
  pollTimer = setInterval(() => {
    // –ø—ñ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π
    if (document.visibilityState === 'visible') fetchData(false);
  }, POLL_MS);
}

function stopPolling(){
  if (pollTimer){
    clearInterval(pollTimer);
    pollTimer = null;
  }
}

// —Å—Ç–∞—Ä—Ç: —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ –≤–∏–¥–∏–º–∞
if (document.visibilityState === 'visible') startPolling();

// –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–≤–µ–¥—ñ–Ω–∫—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤–∏–¥–∏–º–æ—Å—Ç—ñ
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible'){
    // –æ–¥—Ä–∞–∑—É –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ —Å–≤—ñ–∂—ñ –¥–∞–Ω—ñ (–¥–æ—Ç—Ä–∏–º–∞—î—Ç—å—Å—è cooldown)
    fetchData(false);
    startPolling();
  } else {
    // —É —Ñ–æ–Ω—ñ –Ω–µ —Ä–æ–±–∏–º–æ –∑–∞–π–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
    stopPolling();
  }
});
  
})();
</script>
</body>
</html>
