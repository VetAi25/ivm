<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IVM ‚Äî I'm Vetstar Manager</title>
<meta name="color-scheme" content="light dark"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#f6f9ff;
    --card:#fff;
    --ink:#0b1b3a;
    --muted:#6b7a90;
    --blue:#1f6feb;
    --blue-600:#1656b8;
    --orange:#ff8a3d;
    --ring:#dde7ff;
    --ok:#12b981;
    --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  }
  .wrap{max-width:720px;margin:0 auto;padding:16px 14px 40px}
  .card{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:16px;
    padding:16px 18px;
    box-shadow:0 6px 16px rgba(31,111,235,.05);
  }
  .greeting{
    background:linear-gradient(135deg,#e9f1ff,#fff);
    border:1px solid #d7e4ff;
  }
  .hello{font-weight:700;font-size:18px;margin-bottom:8px}
  .stats{font-size:14px;line-height:1.6}
  .stats b{font-weight:700}
  .stats .emoji{font-size:18px;margin-left:6px}
  .grid{
    margin-top:18px;
    display:grid;
    gap:10px;
  }
  @media(min-width:540px){.grid{grid-template-columns:1fr 1fr}}
  .btn{
    display:flex;align-items:center;justify-content:center;
    gap:8px;padding:14px 10px;text-decoration:none;
    border-radius:14px;font-weight:600;
    border:1px solid var(--ring);
    background:var(--card);
    color:var(--ink);
    box-shadow:0 4px 12px rgba(31,111,235,.05);
    transition:.15s ease;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(31,111,235,.08)}
  .btn:active{transform:none}
  .btn.disabled{
    opacity:.55;
    pointer-events:none;
  }
  .btn .emoji{font-size:18px}
  .foot{
    margin-top:24px;font-size:12px;color:var(--muted);text-align:center
  }
  .skeleton{
    background:linear-gradient(90deg,#eef3ff 25%,#f7faff 37%,#eef3ff 63%);
    background-size:400% 100%;animation:sk 1.4s ease infinite
  }
  @keyframes sk{0%{background-position:100% 0}100%{background-position:0 0}}
  .sktext{height:14px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card greeting" id="greetingCard">
    <div class="hello" id="greeting">–î–æ–±—Ä–∏–π –¥–µ–Ω—å, ...</div>
    <div class="stats" id="stats">
      <div>–°—å–æ–≥–æ–¥–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω—å: <b id="ordersCount">‚Äî</b> <span class="emoji" id="ordersEmoji">üò¥</span></div>
      <div>–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å: <b id="ordersSum">‚Äî –≥—Ä–Ω</b></div>
      <div>–ü–æ–¥—ñ–π –∫–æ–º–ø–∞–Ω—ñ—ó: <b id="eventsToday">‚Äî</b></div>
      <div>–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π: <b id="eventsPlanned">‚Äî</b></div>
    </div>
  </div>

  <div class="grid">
    <a href="ivm-orders.html" class="btn"><span class="emoji">üìù</span> –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ —Ä–æ–±–æ—Ç—ñ</a>
    <a href="ivm-debts.html" class="btn"><span class="emoji">üí∞</span> –ó–∞–±–æ—Ä–≥–æ–≤–∞–Ω—ñ—Å—Ç—å –ø–æ –∫–ª—ñ—î–Ω—Ç–∞–º</a>
    <div class="btn disabled"><span class="emoji">üóÇÔ∏è</span> –ê–∫—Ç–∏ –∑–≤—ñ—Ä–æ–∫</div>
    <div class="btn disabled"><span class="emoji">üìÖ</span> –ü–æ–¥—ñ—ó –∫–æ–º–ø–∞–Ω—ñ—ó</div>
    <div class="btn disabled"><span class="emoji">üß≠</span> –ü–ª–∞–Ω –¥–Ω—è</div>
  </div>

  <div class="foot">
    <small>IVM WebApp ‚Ä¢ VETSTAR</small>
  </div>
</div>

<script>
(() => {
  const WEBHOOK_URL = "https://n8n.vetai.win/webhook/15e5d5bf-ce7b-4850-8f1b-7bb7d28ecff9"; // üîó –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π
  
  const tg = window.Telegram?.WebApp;
  if(tg){ tg.ready(); tg.expand(); }

  const els = {
    greeting: document.getElementById("greeting"),
    ordersCount: document.getElementById("ordersCount"),
    ordersEmoji: document.getElementById("ordersEmoji"),
    ordersSum: document.getElementById("ordersSum"),
    eventsToday: document.getElementById("eventsToday"),
    eventsPlanned: document.getElementById("eventsPlanned"),
  };

  function greetingText(name){
    const h = new Date().getHours();
    const greet = h < 12 ? "–î–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫" : h < 18 ? "–î–æ–±—Ä–∏–π –¥–µ–Ω—å" : "–î–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä";
    return `${greet}, ${name || "–º–µ–Ω–µ–¥–∂–µ—Ä–µ"}!`;
  }

  function orderEmoji(c){
    c = Number(c) || 0;
    if(c === 0) return "üò¥";
    if(c <= 5) return "üòï";
    if(c <= 10) return "üôÇ";
    if(c <= 15) return "üòÑ";
    if(c <= 20) return "üòÅ";
    if(c <= 30) return "üòé";
    if(c <= 40) return "ü§ë";
    return "ü§Ø";
  }

  async function loadData(){
    try{
      const telegram_id = tg?.initDataUnsafe?.user?.id || new URLSearchParams(location.search).get("id");
      if(!telegram_id) throw new Error("–ù–µ–º–∞—î Telegram ID");

      // –í–∏–∫–æ–Ω—É—î–º–æ GET-–∑–∞–ø–∏—Ç –¥–æ n8n
      const url = `${WEBHOOK_URL}?telegram_id=${encodeURIComponent(telegram_id)}&source=IVM-DASHBOARD&_t=${Date.now()}`;
      const res = await fetch(url, { method: "GET", headers: {"Accept":"application/json"} });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if(!data.ok) throw new Error("access denied");

      els.greeting.textContent = greetingText(data.first_name || "");
      els.ordersCount.textContent = data.orders_count ?? 0;
      els.ordersEmoji.textContent = orderEmoji(data.orders_count);
      els.ordersSum.textContent = (data.orders_sum ?? 0).toLocaleString("uk-UA") + " –≥—Ä–Ω";
      els.eventsToday.textContent = data.events_today ?? "0";
      els.eventsPlanned.textContent = data.events_planned ?? "0";

    }catch(err){
      console.warn("Fetch error:", err);
      els.greeting.textContent = "‚ö†Ô∏è –î–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ";
    }
  }

  document.addEventListener("DOMContentLoaded", loadData);
  window.addEventListener("pageshow", e => { if(e.persisted) loadData(); });
})();
</script>
</body>
</html>
