<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IVM ‚Äî I'm Vetstar Manager</title>
<meta name="color-scheme" content="light dark"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#f6f9ff;
    --card:#fff;
    --ink:#0b1b3a;
    --muted:#6b7a90;
    --blue:#1f6feb;
    --green:#12b981;
    --orange:#f59e0b;
    --ring:#dde7ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  }
  .wrap{max-width:720px;margin:0 auto;padding:16px 14px 40px}
  .card{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:16px;
    padding:16px 18px;
    box-shadow:0 6px 16px rgba(31,111,235,.05);
  }
  .greeting{
    background:linear-gradient(135deg,#e9f1ff,#fff);
    border:1px solid #d7e4ff;
  }
  .hello{font-weight:700;font-size:18px;margin-bottom:8px}
  .stats{font-size:14px;line-height:1.6}
  .stats b{font-weight:700}
  .stats b.orders{color:var(--blue)}
  .stats b.sum{color:var(--green)}
  .stats b.events{color:var(--orange)}
  .stats .emoji{font-size:18px;margin-left:6px}
  .motivation{
    margin-top:8px;
    font-size:13px;
    color:var(--muted);
    font-style:italic;
    transition:opacity .3s ease;
  }
  .grid{
    margin-top:18px;
    display:grid;
    gap:10px;
  }
  @media(min-width:540px){.grid{grid-template-columns:1fr 1fr}}
  .btn{
    display:flex;align-items:center;justify-content:center;
    gap:8px;padding:14px 10px;text-decoration:none;
    border-radius:14px;font-weight:600;
    border:1px solid var(--ring);
    background:var(--card);
    color:var(--ink);
    box-shadow:0 4px 12px rgba(31,111,235,.05);
    transition:.15s ease;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(31,111,235,.08)}
  .btn:active{transform:none}
  .btn.disabled{opacity:.55;pointer-events:none;}
  .btn .emoji{font-size:18px}
  .foot{margin-top:24px;font-size:12px;color:var(--muted);text-align:center}

  /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø—É–ª—å—Å—É */
  .pulse {animation:pulse 450ms ease;}
  @keyframes pulse{
    0%{transform:scale(1);filter:brightness(1);}
    40%{transform:scale(1.06);filter:brightness(1.15);}
    100%{transform:scale(1);filter:brightness(1);}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card greeting" id="greetingCard">
    <div class="hello" id="greeting">–î–æ–±—Ä–∏–π –¥–µ–Ω—å, ...</div>
    <div class="stats">
      <div>–°—å–æ–≥–æ–¥–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω—å:
        <b id="ordersCount" class="orders">‚Äî</b>
        <span class="emoji" id="ordersEmoji">üò¥</span>
      </div>
      <div>–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å:
        <b id="ordersSum" class="sum">‚Äî –≥—Ä–Ω</b>
        <span class="emoji" id="sumEmoji">üò¥</span>
      </div>
      <div>–ü–æ–¥—ñ–π –∫–æ–º–ø–∞–Ω—ñ—ó: <b id="eventsToday" class="events">‚Äî</b></div> 
      <div>–ó–∞–≤–¥–∞–Ω—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞: <b id="eventsPlanned" class="events">‚Äî</b></div>
    </div>
    <div class="motivation" id="motivation">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
  </div>

  <div class="grid">
    <a href="ivm-orders.html" class="btn"><span class="emoji">üìù</span> –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ —Ä–æ–±–æ—Ç—ñ</a>
    <a href="ivm-debtors.html" class="btn"><span class="emoji">üí∞</span> –ó–∞–±–æ—Ä–≥–æ–≤–∞–Ω—ñ—Å—Ç—å –ø–æ –∫–ª—ñ—î–Ω—Ç–∞–º</a>
    <div class="btn disabled"><span class="emoji">üóÇÔ∏è</span> –ê–∫—Ç–∏ –∑–≤—ñ—Ä–æ–∫</div>
    <div class="btn disabled"><span class="emoji">üìÖ</span> –ü–æ–¥—ñ—ó –∫–æ–º–ø–∞–Ω—ñ—ó</div>
    <div class="btn disabled"><span class="emoji">üß≠</span> –ü–ª–∞–Ω –¥–Ω—è</div>
    <div class="btn disabled"><span class="emoji">üôç‚Äç‚ôÇÔ∏è</span> –ù–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç</div>
  </div>

  <div class="foot">
    <small>IVM WebApp ‚Ä¢ VETSTAR</small>
  </div>
</div>

<script>
(() => {
  const WEBHOOK_URL = "https://n8n.vetai.win/webhook/15e5d5bf-ce7b-4850-8f1b-7bb7d28ecff9";
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const els = {
    greeting: document.getElementById("greeting"),
    ordersCount: document.getElementById("ordersCount"),
    ordersEmoji: document.getElementById("ordersEmoji"),
    ordersSum: document.getElementById("ordersSum"),
    sumEmoji: document.getElementById("sumEmoji"),
    eventsToday: document.getElementById("eventsToday"),
    eventsPlanned: document.getElementById("eventsPlanned"),
    motivation: document.getElementById("motivation"),
  };

  function greetingText(name){
    const h = new Date().getHours();
    const greet = h < 12 ? "–î–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫" : h < 18 ? "–î–æ–±—Ä–∏–π –¥–µ–Ω—å" : "–î–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä";
    return `${greet}, ${name || "–º–µ–Ω–µ–¥–∂–µ—Ä–µ"}!`;
  }

  function orderEmoji(c){
    c = Number(c) || 0;
    if (c === 0) return "üò¥";
    if (c <= 5) return "üòï";
    if (c <= 10) return "üôÇ";
    if (c <= 15) return "üòÑ";
    if (c <= 20) return "üòÅ";
    if (c <= 30) return "üòé";
    if (c <= 40) return "üí™";
    return "üöÄ";
  }

  function sumEmoji(sum){
    sum = Number(sum) || 0;
    if (sum === 0) return "üò¥";
    if (sum < 5000) return "üòï";
    if (sum < 20000) return "üôÇ";
    if (sum < 50000) return "üòÑ";
    if (sum < 100000) return "üòé";
    if (sum < 200000) return "ü§ë";
    return "ü§Ø";
  }

  // –ú–æ—Ç–∏–≤–∞—Ü—ñ–π–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  function motivationText(c, sum){
    if (c === 0) return "–†–æ–∑—ñ–≥—Ä—ñ–≤–∞—î–º–æ—Å—å ‚òïÔ∏è ‚Äî —É—Å–µ –ø–æ–ø–µ—Ä–µ–¥—É!";
    if (sum < 5000) return "–ü–æ—á–∞—Ç–æ–∫ —î, —Ä—É—Ö–∞—î–º–æ—Å—å üí™";
    if (sum < 20000) return "–î–æ–±—Ä–∏–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–¥–∞–∂—ñ–≤ üòé";
    if (sum < 50000) return "–°–ø—Ä–∞–≤–∂–Ω—ñ–π –¥—Ä–∞–π–≤, —Ç—Ä–∏–º–∞–π —Ç–µ–º–ø üöÄ";
    if (sum < 100000) return "–¢–∏ –Ω–∞ —à–ª—è—Ö—É –¥–æ —Ä–µ–∫–æ—Ä–¥—É üèÜ";
    if (sum < 200000) return "–í—Ä–∞–∂–∞—é—á–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üî•";
    return "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞! –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–Ω—è üåü";
  }

  // --- –ê–Ω—ñ–º–∞—Ü—ñ—è —á–∏—Å–µ–ª ---
  function animateNumber(el, to, {duration=700, format} = {}){
    const from = Number((el.dataset.value ?? '').replace(/[^\d.-]/g,'')) || 0;
    const target = Number(to) || 0;
    const start = performance.now();
    const ease = t => t<.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
    function frame(now){
      const p = Math.min(1, (now - start)/duration);
      const v = from + (target - from) * ease(p);
      el.textContent = format ? format(v) : Math.round(v);
      if (p < 1) requestAnimationFrame(frame);
      else el.dataset.value = String(target);
    }
    el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
    requestAnimationFrame(frame);
  }

  const fmtInt = v => Math.round(v).toLocaleString('uk-UA');
  const fmtUAH = v => `${(Math.round(v*100)/100).toLocaleString('uk-UA')} –≥—Ä–Ω`;

  async function loadData(){
    try{
      const telegram_id = tg?.initDataUnsafe?.user?.id || "";
      const url = new URL(WEBHOOK_URL);
      url.searchParams.set("telegram_id", telegram_id);
      url.searchParams.set("source", "IVM-DASHBOARD");
      url.searchParams.set("timestamp", new Date().toISOString());

      const res = await fetch(url.toString(), { method: "GET", headers: {"Accept": "application/json"} });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      let data = await res.json();
      if (Array.isArray(data)) data = data[0];
      if (!data?.ok) throw new Error("access denied");

      els.greeting.textContent = greetingText(data.first_name || "");
      animateNumber(els.ordersCount, data.orders_count ?? 0, { format: fmtInt });
      animateNumber(els.ordersSum,   data.orders_sum   ?? 0, { format: fmtUAH });
      els.ordersEmoji.textContent = orderEmoji(data.orders_count);
      els.sumEmoji.textContent    = sumEmoji(data.orders_sum);
      animateNumber(els.eventsToday,   data.events_today   ?? 0, { format: fmtInt });
      animateNumber(els.eventsPlanned, data.events_planned ?? 0, { format: fmtInt });

      // –º–æ—Ç–∏–≤–∞—Ü—ñ—è
      els.motivation.style.opacity = 0;
      setTimeout(() => {
        els.motivation.textContent = motivationText(data.orders_count, data.orders_sum);
        els.motivation.style.opacity = 1;
      }, 300);

    } catch(err){
      console.warn("Fetch error:", err);
      els.greeting.textContent = "‚ö†Ô∏è –î–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ";
      els.ordersCount.textContent = "‚Äî";
      els.ordersSum.textContent = "‚Äî –≥—Ä–Ω";
      els.eventsToday.textContent = "‚Äî";
      els.eventsPlanned.textContent = "‚Äî";
      els.motivation.textContent = "–ù–µ–º–∞—î –∑–≤'—è–∑–∫—É —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º üòï";
    }
  }

  document.addEventListener("DOMContentLoaded", loadData);
  window.addEventListener("pageshow", e => { if(e.persisted) loadData(); });
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") loadData();
  });
})();
</script>
</body>
</html>
