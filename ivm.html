<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IVM ‚Äî I'm Vetstar Manager</title>
  <meta name="color-scheme" content="light dark"/>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f6f9ff;
      --card:#ffffff;
      --ink:#0b1b3a;
      --muted:#6b7a90;
      --blue:#1f6feb;
      --blue-600:#1656b8;
      --orange:#ff8a3d;
      --ring:#dde7ff;
      --ok:#12b981;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 14px 40px}
    .appbar{
      display:flex;gap:12px;align-items:center;
      background:var(--card);border:1px solid var(--ring);
      border-radius:14px;padding:12px 12px 12px 12px;
      box-shadow:0 6px 16px rgba(31,111,235,.06);
    }
    .avatar{
      width:56px;height:56px;border-radius:50%;
      background:linear-gradient(135deg,#d7e6ff,#fff);
      border:1px solid var(--ring);display:grid;place-items:center;
      overflow:hidden;flex:0 0 56px;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar span{font-weight:700;color:var(--blue)}
    .titlebox{min-width:0}
    .name{font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cardlink{
      display:inline-block;margin-top:2px;font-size:13px;text-decoration:none;
      color:var(--blue);border-bottom:1px dashed var(--blue);padding-bottom:1px;
    }
    .badge{
      margin-left:auto;font-size:12px;color:#fff;background:var(--blue);
      padding:6px 10px;border-radius:999px;border:1px solid var(--blue-600)
    }

    .section{margin-top:16px}
    .notice{
      background:var(--card);border:1px dashed var(--ring);color:var(--muted);
      border-radius:12px;padding:10px 12px;font-size:13px
    }
    .grid{
      margin-top:14px;display:grid;gap:10px
    }
    @media (min-width:540px){ .grid{grid-template-columns:1fr 1fr} }

    .btn{
      display:flex;align-items:center;justify-content:center;gap:10px;
      background:var(--card);
      border:1px solid var(--ring);border-radius:14px;padding:14px 12px;
      text-decoration:none;color:var(--ink);font-weight:600;
      transition:.15s transform ease,.15s box-shadow ease,.15s border-color ease;
      box-shadow:0 4px 12px rgba(31,111,235,.05);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(31,111,235,.08)}
    .btn:active{transform:translateY(0)}
    .btn .emoji{font-size:18px;line-height:1}

    .accent{border-left:6px solid var(--orange)}

    .foot{
      margin-top:20px;font-size:12px;color:var(--muted);text-align:center
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--ring);
      background:#fff;font-size:12px
    }
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .skeleton{
      background:linear-gradient(90deg,#eef3ff 25%,#f7faff 37%,#eef3ff 63%);
      background-size:400% 100%;animation:sk 1.4s ease infinite
    }
    @keyframes sk{0%{background-position:100% 0}100%{background-position:0 0}}
    .sktext{height:14px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- –í–µ—Ä—Ö–Ω—è –ø–ª–∞—à–∫–∞ -->
    <div class="appbar">
      <div class="avatar" id="avatar">
        <span id="avatarText">AV</span>
      </div>
      <div class="titlebox">
        <div class="name" id="fullName"><span class="sktext skeleton" style="display:inline-block;width:180px"></span></div>
        <a id="cardLink" class="cardlink" href="#" target="_blank" rel="noopener">–≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—ñ–∑–∏—Ç—ñ–≤–∫—É</a>
      </div>
      <div class="badge" id="statusPill">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶</div>
    </div>

    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ —Å–µ–∫—Ü—ñ—è -->
    <div class="section">
      <div class="notice" id="notice">
        IVM –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è. –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Å–ª—É–∂–±–æ–≤—ñ –¥–∞–Ω—ñ –¥–æ VETAi –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–æ—Å—Ç—É–ø—É‚Ä¶
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —Ä–æ–∑–¥—ñ–ª—ñ–≤ -->
    <div class="section">
      <div class="grid">
        <a class="btn accent" href="ivm-orders.html"><span class="emoji">üìù</span> –©–æ –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º</a>
        <a class="btn" href="ivm-plan.html"><span class="emoji">üçå</span> –ü–ª–∞–Ω-–±–∞–Ω–∞–Ω</a>
        <a class="btn" href="ivm-heroes.html"><span class="emoji">üèÜ</span> –•—Ç–æ –º–æ–ª–æ–¥–µ—Ü—å</a>
        <a class="btn" href="ivm-me.html"><span class="emoji">ü§∑‚Äç‚ôÇÔ∏è</span> –Ü —â–æ —è</a>
        <a class="btn" href="ivm-promo.html"><span class="emoji">üéà</span> –®–∞—Ä–∞</a>
        <a class="btn" href="ivm-boring.html"><span class="emoji">ü´†</span> –°–∫—É–∫–æ—Ç–∞</a>
        <a class="btn" href="ivm-smart.html"><span class="emoji">üë®‚Äçüéì</span> –¢—Ä–µ–±–∞ –ø–æ—É–º–Ω—ñ—á–∞—Ç—å</a>
        <a class="btn" href="ivm-good.html"><span class="emoji">üçä</span> –©–æ—Å—å —Ö–æ—Ä–æ—à–µ</a>
      </div>
    </div>

    <div class="foot">
      <span class="pill" id="envPill">IVM WebApp ‚Ä¢ VETSTAR</span>
    </div>
  </div>

  <script>
    // ====== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ======
    const WEBHOOK_URL_DEFAULT = "https://n8n.vetai.win/webhook/681fc49a-7da6-41d7-97a3-718c1cbad8ab"; // –∑–º—ñ–Ω–∏—Ç–∏ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏
    // ==========================

    const qs = new URLSearchParams(location.search);
    const WEBHOOK_URL = qs.get("webhook") || WEBHOOK_URL_DEFAULT;

    const tg = window.Telegram?.WebApp;
    const dom = {
      avatar: document.getElementById("avatar"),
      avatarText: document.getElementById("avatarText"),
      fullName: document.getElementById("fullName"),
      cardLink: document.getElementById("cardLink"),
      statusPill: document.getElementById("statusPill"),
      notice: document.getElementById("notice"),
      envPill: document.getElementById("envPill"),
    };

    function safe(fn, fallback){
      try { return fn(); } catch(e){ return fallback; }
    }

    function initials(name){
      if(!name) return "AV";
      const parts = name.trim().split(/\s+/).slice(0,2);
      return parts.map(p=>p[0]?.toUpperCase()||"").join("") || "AV";
    }

    function setAvatarPhoto(url, fallbackInitials){
      if(url){
        const img = new Image();
        img.onload = ()=>{ dom.avatar.innerHTML=""; dom.avatar.appendChild(img); };
        img.onerror = ()=>{ dom.avatar.innerHTML=`<span>${fallbackInitials}</span>`; };
        img.src = url;
      } else {
        dom.avatar.innerHTML = `<span>${fallbackInitials}</span>`;
      }
    }

    // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ Telegram WebApp
    if(tg){
      tg.ready();
      tg.expand();
    }

    // –ó–±—ñ—Ä —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—ó –∑ Telegram –¥–ª—è –±–µ–∫–µ–Ω–¥—É
    const initData = safe(()=>tg.initData, "");
    const initDataUnsafe = safe(()=>tg.initDataUnsafe, {});
    const themeParams = safe(()=>tg.themeParams, {});
    const platform = safe(()=>tg.platform, "unknown");
    const version = safe(()=>tg.version, "n/a");

    // –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –ø–æ–∫–∏ —á–µ–∫–∞—î–º–æ n8n
    const fallbackName = initDataUnsafe?.user
      ? [initDataUnsafe.user?.last_name, initDataUnsafe.user?.first_name].filter(Boolean).join(" ")
      : "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á VETSTAR";

    dom.fullName.textContent = fallbackName || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á VETSTAR";
    dom.avatarText.textContent = initials(fallbackName);

    // –°–ø—Ä–æ–±–∞ –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç–∏ —Ñ–æ—Ç–æ –∑ Telegram –ø—Ä–æ—Ñ—ñ–ª—é (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–æ)
    const tgPhoto = initDataUnsafe?.user?.photo_url || null;
    setAvatarPhoto(tgPhoto, initials(fallbackName));

    // –ü–ª–∞—à–∫–∞ –æ—Ç–æ—á–µ–Ω–Ω—è
    dom.envPill.textContent = `IVM WebApp ‚Ä¢ ${platform || "unknown"} ‚Ä¢ v${version || "n/a"}`;

    // –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –≤–µ–±—Ö—É–∫–∞ —É n8n
    const payload = {
      source: "IVM-START",
      timestamp: new Date().toISOString(),
      initData,
      initDataUnsafe, // user/chat/query_id/start_param —Ç–æ—â–æ
      themeParams,
      platform,
      version,
      locationHref: location.href
    };

    let sent = false;

    async function sendWebhook(){
      if(sent) return;
      sent = true;

      dom.statusPill.textContent = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶";

      try{
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          // –í–ê–ñ–õ–ò–í–û: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ n8n –≤–∏—Å—Ç–∞–≤–ª–µ–Ω–æ CORS-–∑–∞–≥–æ–ª–æ–≤–∫–∏:
          // Access-Control-Allow-Origin: * (–∞–±–æ —Ç–≤—ñ–π –¥–æ–º–µ–Ω GitHub Pages)
        });

        // –Ø–∫—â–æ n8n –ø–æ–≤–µ—Ä—Ç–∞—î JSON
        let data = null;
        try { data = await res.json(); } catch(_){ data = null; }

        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }

        // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ n8n
        const ok = !!(data?.ok);
        const fn = data?.first_name || initDataUnsafe?.user?.first_name || "";
        const ln = data?.last_name  || initDataUnsafe?.user?.last_name  || "";
        const display = data?.display_name || [ln, fn].filter(Boolean).join(" ") || fallbackName;
        const photo = data?.photo_url || tgPhoto || null;
        const cardUrl = data?.card_url || "#";

        dom.fullName.textContent = display;
        setAvatarPhoto(photo, initials(display));
        dom.cardLink.href = cardUrl;
        dom.cardLink.target = cardUrl === "#" ? "_self" : "_blank";

        if(ok){
          dom.statusPill.textContent = "–î–æ—Å—Ç—É–ø –Ω–∞–¥–∞–Ω–æ";
          dom.statusPill.style.background = "var(--ok)";
          dom.notice.innerHTML = "‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–æ–π–¥–µ–Ω–∞. –ú–æ–∂–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å —Ä–æ–∑–¥—ñ–ª–∞–º–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É.";
        } else {
          dom.statusPill.textContent = "–î–æ—Å—Ç—É–ø –æ–±–º–µ–∂–µ–Ω–æ";
          dom.statusPill.style.background = "var(--err)";
          dom.notice.innerHTML = "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–±–æ –æ–±–º–µ–∂–µ–Ω–æ. –Ø–∫—â–æ –≤–≤–∞–∂–∞—î—Ç–µ —Ü–µ –ø–æ–º–∏–ª–∫–æ—é ‚Äî –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.";
          // –ó–∞ –ø–æ—Ç—Ä–µ–±–∏: –≤—ñ–¥–∫–ª—é—á–∏—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏
          document.querySelectorAll(".btn").forEach(b=>b.addEventListener("click", e=>{
            e.preventDefault();
          }));
        }

      }catch(err){
        // –ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∞–±–æ CORS ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, –∞–ª–µ –Ω–µ –±–ª–æ–∫—É—î–º–æ UI
        dom.statusPill.textContent = "–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º";
        dom.statusPill.style.background = "var(--orange)";
        dom.notice.innerHTML = "‚ö†Ô∏è –ù–µ–º–∞—î –∑–≤ º—è–∑–∫—É –∑ VETAi/n8n (–º–æ–∂–ª–∏–≤–∏–π CORS –∞–±–æ –º–µ—Ä–µ–∂–∞). –î–∞–Ω—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –∑ Telegram. " +
          "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–µ–±—Ö—É–∫ –∞–±–æ CORS-–∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ.";
        console.error("Webhook error:", err);
      }
    }

    // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –≤–µ–±—Ö—É–∫–∞
    sendWebhook();

    // –ö–ª—ñ–∫ ¬´–≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—ñ–∑–∏—Ç—ñ–≤–∫—É¬ª ‚Äî —è–∫—â–æ –±–µ–∫–µ–Ω–¥ —â–µ –Ω–µ –ø–æ–¥–∞–≤ url, –∑–∞–ª–∏—à–∞—î–º–æ '#'
    dom.cardLink.addEventListener("click", (e)=>{
      if(dom.cardLink.getAttribute("href")==="#"){
        e.preventDefault();
      }
    });

  </script>
</body>
</html>
